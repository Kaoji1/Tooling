<div class="layout">
  <app-sidebar></app-sidebar>

  <div class="content-area">

    <div>
      <div class="header">
        <h4>Plan List</h4>
      </div>
      <p>PC Plan List</p>
    </div>

    <div class="view-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
      <button class="view-tab" [class.active]="viewMode === 'monthly'" (click)="setViewMode('monthly')">
        Monthly
      </button>
      <button class="view-tab" [class.active]="viewMode === 'upcoming'" (click)="setViewMode('upcoming')">
        Upcoming
      </button>
      <button class="view-tab" [class.active]="viewMode === 'engineer'" (click)="setViewMode('engineer')">
        Engineer
      </button>
      <button class="view-tab" [class.active]="viewMode === 'qc'" (click)="setViewMode('qc')">
        QC
      </button>
    </div>

    <div class="filter-section">

      <div class="filter-group date-filter">
        <label>Date</label>
        <div class="date-input-wrapper">
          <mat-form-field appearance="outline" style="width: 100%;" subscriptSizing="dynamic">
            <input matInput [matDatepicker]="picker" [(ngModel)]="filterDate" placeholder="DD/MM/YYYY"
              (dateChange)="applyFilter()" (click)="picker.open()" readonly>
            <button *ngIf="filterDate" matSuffix mat-icon-button aria-label="Clear"
              (click)="clearDate(null); $event.stopPropagation()"
              style="width: 24px; height: 24px; line-height: 24px; padding: 0; margin-right: 4px; border: none; background: transparent; cursor: pointer;">
              <i class="bi bi-x-circle-fill" style="color: #ef4444; font-size: 16px;"></i>
            </button>
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
          <button class="btn-today" (click)="setToday(null)">Today</button>
        </div>
      </div>

      <div class="filter-group">
        <label>Division</label>
        <select [(ngModel)]="filterDivision" (change)="applyFilter()">
          <option value="">All</option>
          <option *ngFor="let div of divisions" [value]="div">{{ div }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Machine Type</label>
        <select [(ngModel)]="filterMachineType" (change)="applyFilter()">
          <option value="">All</option>
          <option *ngFor="let m of machineTypes" [value]="m">{{ m }}</option>
        </select>
      </div>

      <!-- Toggle Show History -->
      <div class="filter-group" style="flex-direction: row; align-items: center; gap: 10px; margin-bottom: 5px;">
        <input type="checkbox" id="showHistory" [(ngModel)]="showHistory" (change)="loadPlanList()"
          style="width: 20px; height: 20px;">
        <label for="showHistory" style="margin: 0; cursor: pointer; color: #334155;">Show All Revisions</label>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width: 150px;">Plan Date</th>
            <th class="col-no">Rev</th> <!-- New Column -->
            <th style="width: 120px;">Status</th> <!-- New Column -->
            <th>MC Type</th>
            <th>Division</th>
            <th>Fac</th>
            <th>Process</th>
            <th>Part Before</th>
            <th>MC No.</th>
            <th class="col-part">Part No.</th>
            <th class="col-qty">QTY</th>
            <th>Time</th>
            <th>Comment</th>
            <th>Path Dwg</th>
            <th>Path Layout</th>
            <th>IIQC</th>
            <th>Print</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredPlanList" [class.row-cancelled]="item.planStatus === 'Cancelled'"
            [class.row-latest]="item.isLatest && showHistory" [class.row-history]="!item.isLatest && showHistory"
            [class.group-start]="item.isGroupStart && showHistory" [ngClass]="{
                'row-complete': (item.pathDwg && item.pathDwg !== '-' && item.pathLayout && item.pathLayout !== '-' && item.iiqc && item.iiqc !== '-'),
                'row-incomplete': (!item.pathDwg || item.pathDwg === '-' || !item.pathLayout || item.pathLayout === '-' || !item.iiqc || item.iiqc === '-')
              }">
            <td>
              <div class="date-wrapper">
                <span class="plan-date">{{ item.date }}</span>
                <span class="ref-no" *ngIf="item.groupId && item.groupId.startsWith('PLAN-')" title="Reference No.">
                  {{ item.groupId }}
                </span>
              </div>
            </td>
            <td class="text-center">{{ item.revision }}</td> <!-- New Data -->
            <td class="text-center">
              <span class="badge" [ngClass]="{
                    'bg-danger': item.planStatus === 'Cancelled', 
                    'bg-success': item.planStatus === 'Active'
                }">{{ item.planStatus }}</span>
            </td>
            <td>{{ item.mcType }}</td>
            <td>{{ item.division }}</td>
            <td>{{ item.fac }}</td>
            <td>{{ item.process }}</td>
            <td>{{ item.partBefore }}</td>
            <td>{{ item.mcNo }}</td>
            <td>{{ item.partNo }}</td>
            <td>{{ item.qty }}</td>
            <td>{{ item.time }}</td>
            <td>{{ item.comment }}</td>
            <td class="text-center">
              <ng-container *ngIf="item.pathDwg">
                <a (click)="openFile(item.pathDwg)" title="Click to Open File"
                  style="color: #3b82f6; text-decoration: underline; cursor: pointer;">
                  {{ item.pathDwg }}
                </a>
              </ng-container>
            </td>
            <td class="text-center">
              <ng-container *ngIf="item.pathLayout">
                <a (click)="openFile(item.pathLayout)" title="Click to Open File"
                  style="color: #3b82f6; text-decoration: underline; cursor: pointer;">
                  {{ item.pathLayout }}
                </a>
              </ng-container>
            </td>
            <td class="text-center">
              <ng-container *ngIf="item.iiqc">
                <a (click)="openFile(item.iiqc)" title="Click to Open File"
                  style="color: #3b82f6; text-decoration: underline; cursor: pointer;">
                  {{ item.iiqc }}
                </a>
              </ng-container>
            </td>

            <td style="width: 80px; padding: 4px;">
              <div class="hihi">
                <button class="print-button" (click)="openPrintModal(item)"
                  style="border: none; background: transparent; cursor: pointer;" [disabled]="!canPrint">
                  <i class="bi bi-printer-fill" style="color: black; font-size: 18px;"></i>
                </button>
                <div
                  style="font-size: 11px; color: rgb(151, 4, 4); font-weight: bold; line-height: 1.1; margin-top: 2px;">
                  L: {{ item.printLayoutCount || 0 }}<br>
                  D: {{ item.printDwgCount || 0 }}
                </div>
              </div>
            </td>

            <td style="text-align: center; white-space: nowrap;">
              <button class="btn-action history me-1" (click)="onViewHistory(item)" title="History">
                <i class="bi bi-clock-history"></i>
              </button>
              <button class="btn-action edit me-1" (click)="onEdit(item)" title="Edit">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn-action delete" (click)="onDelete(item)" title="Delete">
                <i class="bi bi-trash-fill"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="filteredPlanList.length === 0">
            <td colspan="18" style="text-align: center; padding: 2rem; color: #64748b;">No data found</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- Edit Modal -->
<div class="modal-backdrop" *ngIf="isEditModalOpen">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Plan (Rev {{editData.revision}})</h3>
      <button class="btn-close" (click)="closeEditModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Date</label>
          <input type="date" [(ngModel)]="editData.dateObj">
        </div>
        <div class="form-group">
          <label>Machine Type</label>
          <input type="text" [(ngModel)]="editData.mcType">
        </div>
        <div class="form-group">
          <label>Facility</label>
          <input type="text" [(ngModel)]="editData.fac">
        </div>
        <div class="form-group">
          <label>Process</label>
          <input type="text" [(ngModel)]="editData.process">
        </div>
        <div class="form-group">
          <label>Part Before</label>
          <input type="text" [(ngModel)]="editData.partBefore">
        </div>
        <div class="form-group">
          <label>MC No.</label>
          <input type="text" [(ngModel)]="editData.mcNo">
        </div>
        <div class="form-group">
          <label>Part No.</label>
          <input type="text" [(ngModel)]="editData.partNo">
        </div>
        <div class="form-group">
          <label>QTY</label>
          <input type="number" [(ngModel)]="editData.qty">
        </div>
        <div class="form-group">
          <label>Time</label>
          <input type="number" [(ngModel)]="editData.time">
        </div>
        <div class="form-group full-width">
          <label>Comment</label>
          <input type="text" [(ngModel)]="editData.comment" name="comment" placeholder="Optional comments...">
        </div>

        <!-- Divider -->
        <div style="grid-column: span 2; border-top: 1px dashed #e2e8f0; margin: 10px 0;"></div>
        <h4 style="grid-column: span 2; font-size: 0.95rem; color: #334155; margin-bottom: 5px;">Attachments
          (Engineer/QC Only)</h4>

        <!-- Path Inputs -->
        <div class="form-group">
          <label>Path Dwg</label>
          <input type="text" [(ngModel)]="editData.pathDwg" name="pathDwg" placeholder="Enter path...">
        </div>
        <div class="form-group">
          <label>Path Layout</label>
          <input type="text" [(ngModel)]="editData.pathLayout" name="pathLayout" placeholder="Enter path...">
        </div>
        <div class="form-group">
          <label>IIQC</label>
          <input type="text" [(ngModel)]="editData.iiqc" name="iiqc" placeholder="Enter path...">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeEditModal()">Cancel</button>
      <button class="btn-save" (click)="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal-backdrop" *ngIf="isHistoryModalOpen">
  <div class="modal-content" style="max-width: 900px;"> <!-- Wider for history -->
    <div class="modal-header">
      <h3>Revision History (Part: {{selectedHistoryItem.partNo}})</h3>
      <button class="btn-close" (click)="closeHistoryModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="table-container" style="box-shadow: none; border: 1px solid #e2e8f0; max-height: 500px;">
        <table>
          <thead>
            <tr>
              <th>Rev</th>
              <th>Date</th>
              <th>Plan Date</th>
              <th>MC Type</th>
              <th>Fac</th>
              <th>Process</th>
              <th>MC No</th>
              <th>Part No</th>
              <th>QTY</th>
              <th>Comment</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let h of historyList" [ngClass]="{'bg-light': h.Revision === selectedHistoryItem.revision}">
              <td class="text-center"><strong>{{ h.Revision }}</strong></td>
              <td>{{ h.DateTime_Record | date:'short' }}</td> <!-- Edit Timestamp -->
              <td>{{ h.date }}</td>
              <td>{{ h.MC_Type }}</td>
              <td>{{ h.Facility }}</td>
              <td>{{ h.Process }}</td>
              <td>{{ h.MC_No }}</td>
              <td>{{ h.PartNo }}</td>
              <td>{{ h.QTY }}</td>
              <td>{{ h.Comment }}</td>
              <td>
                <span class="badge" [ngClass]="{
                                'bg-success': h.PlanStatus !== 'Cancelled',
                                'bg-danger': h.PlanStatus === 'Cancelled'
                            }">{{ h.PlanStatus }}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeHistoryModal()">Close</button>
    </div>
  </div>
</div>

<!-- Print Modal -->
<div class="modal-backdrop" *ngIf="isPrintModalOpen">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3>Print Preview</h3>
      <button class="btn-close" (click)="closePrintModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid" *ngIf="selectedItemForPrint">
        <!-- Info -->
        <div style="grid-column: span 2;">
          <p><strong>Part No:</strong> {{ selectedItemForPrint.partNo }} </p>
          <p><strong>MC No:</strong> {{ selectedItemForPrint.mcNo }} </p>
        </div>

        <!-- Controls -->
        <div class="form-group">
          <label>Type</label>
          <select [(ngModel)]="printType" (change)="onPrintTypeChange()">
            <option [ngValue]="null" disabled selected>Select Type</option>
            <option *ngFor="let opt of printTypeOptions" [value]="opt.value">{{ opt.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Copies</label>
          <input type="number" [(ngModel)]="printQty" min="1">
        </div>

        <!-- Preview -->
        <div style="grid-column: span 2; height: 400px; border: 1px solid #ddd; margin-top: 10px;">
          <iframe *ngIf="previewUrl" [src]="previewUrl" width="100%" height="100%" style="border: none;"></iframe>
          <div *ngIf="!previewUrl"
            style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">
            Select Type to Preview (PDF Only)
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <div style="color: red; font-weight: bold; margin-right: auto; font-size: 0.9em;">
        * Please have the printer ready before pressing print<br>
        <span style="color: #666; font-weight: normal; font-size: 0.85em;">* Note: Please manually set number of copies
          in the print dialog.</span>
      </div>
      <button class="btn-cancel" (click)="closePrintModal()">Close</button>
      <button class="btn-save" (click)="printPdf()">Print</button>
    </div>
  </div>
</div>