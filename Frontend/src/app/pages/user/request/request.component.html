<div class="layout">
  <app-sidebar></app-sidebar>

  <div class="content-area">

    <div class="header">
      <h4 *ngIf="Tooling_ === 'Setup tool'"> Request Setup Tool </h4>
      <h4 *ngIf="Tooling_ !== 'Setup tool'"> Request Tooling</h4>
    </div>
    <p>Product Requisition</p>

    <div class="group-req">

      <div class="req-row1">
        <div class="group-select">
          <label> Division </label>
          <ng-select [items]="Division" bindLabel="DivisionName" [(ngModel)]="Div_"
            (ngModelChange)="onDivisionChange($event)" [virtualScroll]="true" placeholder="Select Division">
          </ng-select>
        </div>

        <div class="group-select">
          <label> Fac </label>
          <ng-select [items]="Fac" bindLabel="FacilityShort" [(ngModel)]="Fac_" placeholder="Select a Fac"
            [virtualScroll]="true">
          </ng-select>
        </div>

        <div class="group-select">
          <label for="phonenumber"> Phone Number </label>
          <input type="tel" class="form-control" placeholder="Enter your phone number" id="phonenumber"
            [(ngModel)]="phone_" />
        </div>

        <div class="group-select">
          <label for="date"> DueDate </label>
          <input type="date" class="form-control" placeholder="Enter date" id="date" [min]="today_"
            [(ngModel)]="DueDate_" />
        </div>

        <div class="group-select" style="width: 180px;">
          <label> Case </label>
          <ng-select [items]="Case" bindLabel="label" bindValue="value" [(ngModel)]="Case_" [virtualScroll]="true"
            placeholder="Select a case" (change)="onCaseChange()">
          </ng-select>
        </div>
      </div>

      <!-- Section to choose Tooling Type when Case is NOT SET -->
      <div class="tooling-selection" *ngIf="Case_ && Case_ !== 'SET' && !Tooling_"
        style="margin: 20px 0; text-align: center;">
        <h5 style="margin-bottom: 15px; color: #555;">Please select Request Type:</h5>
        <div style="display: flex; gap: 20px; justify-content: center;">
          <button class="btn btn-primary" (click)="selectTooling('Cutting tool')" style="padding: 10px 20px;">
            <i class="bi bi-scissors"></i> Cutting Tool
          </button>
          <button class="btn btn-warning" (click)="selectTooling('Setup tool')" style="padding: 10px 20px;">
            <i class="bi bi-tools"></i> Setup Tool
          </button>
        </div>
      </div>

      <div *ngIf="Tooling_">
        <div style="width: 100%; margin-bottom: 10px; font-weight: bold; color: #1e3a8a;">
          Selected Mode:
          <span class="badge bg-info text-dark" *ngIf="Case_ !== 'SET'">{{ Tooling_ }}</span>
          <span class="badge bg-success" *ngIf="Case_ === 'SET'">Cutting & Setup Tools</span>
        </div>

        <div class="req-row2">
          <div class="group-select">
            <label> Part No. </label>
            <ng-select [items]="PartNo" bindLabel="PartNo" [(ngModel)]="PartNo_" [virtualScroll]="true"
              (ngModelChange)="get_Process($event)" (change)="onPartNoChange()" placeholder="Select partNo">
            </ng-select>
          </div>

          <div class="group-select">
            <label> Process </label>
            <ng-select [items]="Process" bindLabel="Process" [(ngModel)]="Process_" placeholder="Select process">
            </ng-select>
          </div>

          <div class="group-select">
            <label> Machine Type </label>
            <ng-select [items]="MachineType" bindLabel="MC" [(ngModel)]="MachineType_" placeholder="Select MachineType">
            </ng-select>
          </div>

          <div class="group-select">
            <label for="MCQTY">MC No</label>
            <input type="text" pattern="[0-9,]*" class="form-control" placeholder="Enter your MC No" id="MCQTY"
              [(ngModel)]="MCNo_" />
            <small class="form-text text-muted" style="opacity: 0.7;"> Ex: 100,200,300</small>
          </div>
        </div>
      </div>

      <div class="btn-group-req">
        <button class="btn-viewall" type="button" (click)="Clearall()"> CLEARALL <i class="bi bi-trash3"
            style="margin-right: 3px;"></i></button>
        <button class="btn-view" type="button" (click)="Setview()" [disabled]="loading">
          <ng-container *ngIf="!loading; else loadingTpl">
            VIEW <i class="bi bi-eye-fill"></i>
          </ng-container>
          <ng-template #loadingTpl>
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Loading...
          </ng-template>
        </button>
      </div>

    </div>

    <h5 *ngIf="Case_ === 'SET' && items.length > 0" style="color: #2d2c2c; margin-bottom: 10px;">
      <i class="bi bi-scissors"></i> CuttingTool
    </h5>

    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle text-center">
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" style="transform: scale(1.5);" [(ngModel)]="selectAllChecked"
                (change)="toggleAllCheckboxes()" /></th>
            <th>No.</th>
            <th>Part No.</th>
            <th>Item No.</th>

            <th *ngIf="Tooling_ === 'Setup tool'">Item Name</th>

            <th>Spec</th>
            <th>Process</th>


            <th *ngIf="Tooling_ === 'Cutting tool'">Fresh_Qty</th>
            <th *ngIf="Tooling_ === 'Cutting tool'">Reuse_Qty</th>

            <th>QTY</th>
            <th>Case</th>
            <th>Position</th>
            <th *ngIf="Tooling_ === 'Cutting tool' && Case_ === 'SET'">Detail</th>
          </tr>
        </thead>

        <tbody *ngIf="!Case_ || items.length === 0">
          <tr>
            <td [attr.colspan]="Tooling_ === 'Setup tool' ? 10 : 11" class="text-center text-muted">
              <i class="bi bi-exclamation-circle-fill"></i> Please select item to view.
            </td>
          </tr>
        </tbody>

        <tbody *ngIf="items.length > 0">
          <tr *ngFor="let item of items; let i = index">
            <td [ngClass]="getRowClass(item)"><input type="checkbox" style="transform: scale(1.5);"
                [(ngModel)]="item.checked" /></td>
            <td [ngClass]="getRowClass(item)">{{ i + 1 }}</td>
            <td [ngClass]="getRowClass(item)">{{ item.PartNo }}</td>
            <td [ngClass]="getRowClass(item)">{{ item.ItemNo }}</td>

            <td *ngIf="Tooling_ === 'Setup tool'" [ngClass]="getRowClass(item)">
              {{ item.ItemName || '-' }}
            </td>

            <td [ngClass]="getRowClass(item)">{{ item.SPEC }}</td>
            <td [ngClass]="getRowClass(item)">{{ item.Process }}</td>


            <td *ngIf="Tooling_ === 'Cutting tool'" [ngClass]="getRowClass(item)">{{ item.FreshQty }}</td>
            <td *ngIf="Tooling_ === 'Cutting tool'" [ngClass]="getRowClass(item)">{{ item.ReuseQty }}</td>

            <td [ngClass]="getRowClass(item)"><input type="number" class="yoyu" [(ngModel)]="item.QTY" min="1"
                style="text-align: center; border: 0.5px solid; " /></td>
            <td [ngClass]="getRowClass(item)"> {{ Case_ }} </td>
            <td [ngClass]="getRowClass(item)"> {{ item.Position }} </td>
            <td *ngIf="Tooling_ === 'Cutting tool' && Case_ === 'SET'" [ngClass]="getRowClass(item)">
              <button class="btn-detail" (click)="openDetailModal(item)" title="View Box/Shelf Detail">
                <i class="bi bi-eye-fill"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="Tooling_ === 'Cutting tool' && Case_ === 'SET' && relatedSetupItems.length > 0"
      style="margin-top: 30px;">

      <h5 style="color: #2d2c2c; margin-bottom: 10px;">
        <i class="bi bi-tools"></i> SetupTool
      </h5>

      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-center">
          <thead class="table-light" style="background-color: #ffeeba;">
            <tr>
              <th><input type="checkbox" style="transform: scale(1.5);" /></th>
              <th>No.</th>
              <th>Part No.</th>
              <th>Item No.</th>
              <th>Item Name</th>
              <th>Spec</th>
              <th>Process</th>

              <th>QTY</th>
              <th>Case</th>
              <th>Position</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let setup of relatedSetupItems; let i = index">
              <td><input type="checkbox" style="transform: scale(1.5);" [(ngModel)]="setup.checked" /></td>
              <td>{{ i + 1 }}</td>
              <td>{{ setup.PartNo || '-' }}</td>
              <td>{{ setup.ItemNo || '-' }}</td>
              <td>{{ setup.ItemName || '-' }}</td>
              <td>{{ setup.SPEC || '-' }}</td>
              <td>{{ setup.Process || '-' }}</td>

              <td>
                <input type="number" class="yoyu" [(ngModel)]="setup.QTY" min="1"
                  style="text-align: center; border: 0.5px solid; width: 60px;" />
              </td>
              <td>{{ Case_ }}</td>
              <td>{{ setup.Position || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <button class="btn-sendrequest" type="button" (click)="AddToCart()">
      <i class="bi" [ngClass]="Tooling_ === 'Setup tool' ? 'bi-send-fill' : 'bi-file-earmark-check'"></i>
      &nbsp;
      {{ Tooling_ === 'Setup tool' ? 'Send Request' : 'Submit Request' }}
    </button>
  </div>
</div>

<!-- Modal สำหรับแสดงรายละเอียด Box/Shelf/Rack -->
<div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5><i class="bi bi-box-seam"></i> Storage Location Detail</h5>
      <button class="btn-close-modal" (click)="closeDetailModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="item-info">
        <strong>Item No:</strong> {{ selectedItem?.ItemNo }} &nbsp;|&nbsp;
        <strong>SPEC:</strong> {{ selectedItem?.SPEC }}
      </div>

      <div *ngIf="loadingDetail" class="text-center py-3">
        <span class="spinner-border spinner-border-sm"></span> Loading...
      </div>

      <table class="table table-bordered table-sm" *ngIf="!loadingDetail && detailItems.length > 0">
        <thead class="table-light">
          <tr>
            <th>Box</th>
            <th>Shelf</th>
            <th>Rack</th>
            <th>Fresh Qty</th>
            <th>Reuse Qty</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of detailItems">
            <td>{{ d.BoxName || '-' }}</td>
            <td>{{ d.ShelfName || '-' }}</td>
            <td>{{ d.RackName || '-' }}</td>
            <td class="text-success fw-bold">{{ d.FreshQty }}</td>
            <td class="text-warning fw-bold">{{ d.ReuseQty }}</td>
            <td class="fw-bold">{{ d.TotalQty }}</td>
          </tr>
        </tbody>
      </table>

      <div *ngIf="!loadingDetail && detailItems.length === 0" class="text-muted text-center">
        No detail found.
      </div>
    </div>
  </div>
</div>