<div class="layout"> <!-- เพื่อกำหนดการจัดวางหน้าจอแบบ Flexbox -->

  <app-sidebar></app-sidebar> <!-- แสดงเมนูทางซ้ายมือ -->

  <div class="content-area">

    <div class="header">
      <h4>Return Request</h4>
    </div>

    <div class="header-filters">
      <div class="form-group">
        <label>Division</label>
        <ng-select [items]="divisions" bindLabel="Division_Name" bindValue="Division_Id" placeholder="-- Select --"
          [(ngModel)]="selectedDivisionId" (change)="onDivisionChange()">
        </ng-select>
      </div>

      <div class="form-group">
        <label>Facility</label>
        <ng-select [items]="facilities" bindLabel="label" bindValue="value" placeholder="-- Select --"
          [(ngModel)]="selectedFacility">
        </ng-select>
      </div>

      <div class="form-group">
        <label>Process</label>
        <ng-select [items]="processes" bindLabel="Process" bindValue="Process" placeholder="-- Select --"
          [(ngModel)]="selectedProcess">
        </ng-select>
      </div>

      <div class="form-group">
        <label>Phone Number</label>
        <input type="text" [(ngModel)]="phoneNumber" placeholder="Ex. 1234">
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width: 50px;">No.</th>
            <th>Part No.</th>
            <th>Item No.</th>
            <th>Item Name</th>
            <th>Spec</th>
            <th style="width: 80px;">QTY</th>
            <th>Remark</th>
            <th style="width: 50px;">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of returnItems; let i = index">
            <!-- ใช้ *ngFor วนลูปสร้างแถวตารางตามจำนวนข้อมูลใน Array returnItems -->
            <td class="text-center" style="font-weight: bold; color: #555;">
              <!-- ตัวแปร let i = index ใช้เก็บลำดับแถว (เริ่มจาก 0) เพื่อใช้ในการอ้างอิงและแสดงลำดับที่ -->
              <!-- แสดง {{ i + 1 }} เพื่อให้ลำดับเริ่มจาก 1 (เพราะ index เริ่มที่ 0) -->
              {{ i + 1 }}
            </td>
            <td style="position: relative;">
              <!-- Changed to ng-select for smooth typeahead & overflow handling -->
              <ng-select [items]="searchResults[i]" bindLabel="PartNo" bindValue="PartNo" placeholder="Type ..."
                [(ngModel)]="item.partNo" [typeahead]="partNoInput$" [minTermLength]="2" [addTag]="addTagFn"
                [editableSearchTerm]="true" (focus)="setCurrentRow(i)" (change)="onPartNoSelect(i, $event)"
                (open)="onPartNoOpen()" appendTo="body">
              </ng-select>
            </td>
            <td><input type="text" [(ngModel)]="item.itemNo" (change)="onItemNoChange(i, item.itemNo)"
                placeholder="Scan/Type"></td>
            <td><input type="text" [(ngModel)]="item.itemName"></td>
            <td><input type="text" [(ngModel)]="item.spec"></td>
            <td><input type="number" [(ngModel)]="item.qty"></td>
            <td><input type="text" [(ngModel)]="item.remark"></td>
            <td class="text-center">
              <button class="btn-delete" (click)="removeRow(i)">x</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="action-buttons">
      <button class="btn-add" (click)="addRow()">+</button>

      <button class="btn-submit" (click)="onSubmit()">
        <i class="fa fa-paper-plane"></i> Return
      </button>
    </div>

  </div>
</div>