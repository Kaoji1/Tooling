<!-- ฝั่งด้านแสดงข้อมูลไม่เกี่ยวกับsidebar -->
<div class="cart-layout">
    <!-- เพิ่มsidebarเข้ามา -->
    <app-sidebar></app-sidebar>
         <!--รวมข้อมูลในหน้าทั้งหมด  -->
        <div class="main">
            <div class="header">
        <h4>Cart</h4>
        <app-notification class="noti"></app-notification>
      </div>
      <p>all your request in here</p>
        
<!-- table -->
  <div class="table-responsive">
    <table class="table table-bordered text-center" >
    <!--  thead ตัวเดียว -->
      <thead class="table-dark sticky-top" >
      <tr>
        <th style="width: 50px;">No.</th>
        <th style="width: 150px;">Part No.</th>
        <th style="width: 200px;">Spec</th>
        <th>Process</th>
        <th>MC</th>
        <th>FreshQty</th>
        <th>ReuseQty</th>
        <th>QTY</th>
        <th>Due Date</th>
        <th>Insert</th>
        <th>Edit</th>
        <th>Del</th>
      </tr>
    </thead>

    <!--  tbody เดียว ใช้ ng-container วนกลุ่ม -->
    <tbody>
      <ng-container *ngFor="let caseKey of (groupedCart | keyvalue)">
        <!--  แสดงหัวกลุ่ม Case -->
        <tr class="table-secondary">
          <td colspan="12" class="text-start fw-bold">
            <input type="checkbox"
                  [(ngModel)]="checkedCases[caseKey.key]"
                  style="transform: scale(1.2);" />
            Case: {{ caseKey.key }} | Fac: {{ caseKey.value[0]?.Fac || '-' }}
          </td>
        </tr>

        <!--  แสดงรายการแต่ละกลุ่ม -->
        <tr *ngFor="let item of caseKey.value; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ item.PartNo }}</td>
          <td>{{ item.SPEC }}</td>
          <td>{{ item.Process }}</td>
          <td>{{ item.MCType }}</td>
          <td>{{ item.Fresh_QTY }}</td>
          <td>{{ item.Reuse_QTY }}</td>

         <!-- QTY -->
            <td>
              <ng-container *ngIf="editingIndex[caseKey.key] === i; else showQty">
                <input [(ngModel)]="item.QTY" type="number" class="form-control" />
              </ng-container>
              <ng-template #showQty>{{ item.QTY }}</ng-template>
            </td>

            <!-- Due Date -->
            <td>
              <ng-container *ngIf="editingIndex[caseKey.key] === i; else showDate">
                <input [(ngModel)]="item.Due_Date" type="date" class="form-control" />
              </ng-container>
              <ng-template #showDate>
                {{ item.Due_Date ? (item.Due_Date | date: 'yyyy-MM-dd') : '-' }}
              </ng-template>
            </td>
          <!-- Insert -->
          <td>
            <button class="btn btn-outline-primary btn-sm">
              <i class="bi bi-arrow-down-left-square"></i>
            </button>
          </td>

          <!-- Edit / Save -->
          <td>
            <button *ngIf="editingIndex[caseKey.key] !== i"
                    class="btn btn-primary btn-sm"
                    (click)="startEdit(caseKey.key, i)">
              <i class="bi bi-pencil-square"></i>
            </button>
            <button *ngIf="editingIndex[caseKey.key] === i"
                    class="btn btn-success btn-sm"
                    (click)="saveEdit(caseKey.key, i)">
              <i class="bi bi-check-lg"></i>
            </button>
          </td>

          <!-- Delete -->
          <td>
            <button class="btn btn-danger btn-sm" (click)="removeItem(caseKey.key, i)">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</div>
            <!-- button sendrequest -->
            <button class="btn-sendrequest" type="button"(click)=CreateDocByCase() >
                    <i class="bi bi-send-fill" ></i>Send Request
            </button>

</div>