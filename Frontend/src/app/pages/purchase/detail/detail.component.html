<div class="detail-layout">

  <app-sidebarpurchase></app-sidebarpurchase>

  <div class="main">
    <!-- ข้อความข้างบน   -->
    <div class="toptext">
      <h1>Request List</h1>
      <p>The loan withdrawal request is here.</p>

      <!-- <div class="box-input">
      <div class="form-input">
        <div class="group-select">
          <label for="division">Division</label>
          <ng-select style="width: 145px;" [items]="divisionList" bindLabel="label" bindValue="value"
            [(ngModel)]="Division_" placeholder="Select a Division">
          </ng-select>
        </div>
        <div class="group-select">
          <label for="datesetup">Date</label>
          <input type="date" [(ngModel)]="fromDate" placeholder="datesetup">
        </div> -->

      <!-- <h6>TO</h6> -->

      <!-- <div class="group-select">
          <label for="duedate">Date</label>
          <input type="date" [(ngModel)]="toDate" placeholder="duedate">
        </div> -->



      <div class="top-right-icons">
        <!-- <button onclick="history.back()" class="back-btn">
          <img src="back arrow.png" alt="Back"> BACK
        </button> -->

        <div class="bell-container">
          <!-- <app-notification class="noti"></app-notification> -->
        </div>
      </div>

      <!-- <div class="group-header"> -->

      <!-- <div class="Box-itemNo">
          <h4>ItemNo: {{ itemNo }}</h4>
        </div> -->

      <div class="button-container">



        <div class="button-group">
          <button class="excel-button" type="button" class="btn btn-success" (click)="exportexcel()">
            <i class="bi bi-file-earmark-spreadsheet text-white"></i> EXPORT TO EXCEL</button>
        </div>


        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle custom-btn" type="button" data-bs-toggle="dropdown"
            aria-expanded="false">
            <i class="bi bi-layout-text-sidebar-reverse text-white"></i> Indirect Expense
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="return false;">Cutting Tool</a></li>
            <li><a class="dropdown-item" href="#" onclick="return false;">SetUp Tool</a></li>
            <li><a class="dropdown-item" href="#" onclick="return false;">Cutting Oil</a></li>
          </ul>
        </div>

        <div class="button-clear">
          <button class="btn btn-clear" type="button" (click)="clearFilters()"><i
              class="bi bi-x-circle-fill text-white"></i> Clear</button>
        </div>

        <div class="button-filter">
          <button class="btn btn-filter" type="button" (click)="onFilter()"><i class="bi bi-funnel-fill text-white"></i>
            Filter</button>
        </div>




        <div class="button-Complete">
          <button class="btn-Complete" type="button" (click)="completeSelected()"
            [disabled]="isViewer() || isCompleting">

            <ng-container *ngIf="!isCompleting; else loadingTpl">
              <i class="bi bi-check-circle-fill text-white"></i> Complete
            </ng-container>
            <ng-template #loadingTpl>
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              Loading...
            </ng-template>
          </button>
        </div>
      </div>
      <!-- </div> -->
    </div>

    <!-- กล่อง item no -->
    <!-- ตาราง -->

    <div class="filter-bar">
      <div class="group-select">
        <ng-select [items]="DocumentNoList" bindLabel="label" bindValue="value" [(ngModel)]="DocumentNo_"
          [multiple]="true" [closeOnSelect]="false" placeholder="Select a Document">
        </ng-select>
      </div>

      <div class="group-select">
        <ng-select [items]="divisionList" bindLabel="label" bindValue="value" [(ngModel)]="Division_" [multiple]="true"
          [closeOnSelect]="false" placeholder="Select a Division">
        </ng-select>
      </div>

      <div class="group-select">
        <ng-select [items]="PartNoList" bindLabel="label" bindValue="value" [(ngModel)]="PartNo_" [multiple]="true"
          [closeOnSelect]="false" placeholder="Select a PartNo">
        </ng-select>
      </div>

      <div class="group-select">
        <ng-select [items]="ItemNoList" bindLabel="label" bindValue="value" [(ngModel)]="ItemNo_" [multiple]="true"
          [closeOnSelect]="false" placeholder="Select a ItemNo">
        </ng-select>
      </div>

      <div class="group-select">
        <!-- Spec was squeezed, now has space -->
        <ng-select [items]="SpecList" bindLabel="label" bindValue="value" [(ngModel)]="Spec_" [multiple]="true"
          [closeOnSelect]="false" placeholder="Select a Spec">
        </ng-select>
      </div>

      <div class="group-select">
        <ng-select [items]="ProcessList" bindLabel="label" bindValue="value" [(ngModel)]="Process_" [multiple]="true"
          [closeOnSelect]="false" placeholder="Select a Process">
        </ng-select>
      </div>

      <div class="group-select date-range">
        <input type="date" [(ngModel)]="fromDate" placeholder="From Date" class="form-control">
        <span>-</span>
        <input type="date" [(ngModel)]="toDate" placeholder="To Date" class="form-control">
      </div>

      <div class="group-select">
        <ng-select [items]="CaseList" bindLabel="label" bindValue="value" [(ngModel)]="Case_" [multiple]="true"
          [closeOnSelect]="false" placeholder="Select a Case"></ng-select>
      </div>

    </div>

    <!-- ตาราง -->
    <div class="table-responsive">
      <table id="table-data" class="table table-bordered text-center">
        <thead>
          <tr class="header-group-row">
            <th class="header-production" colspan="22">For Production</th>
            <th class="header-purchase" colspan="9">For Purchase</th>
          </tr>
          <tr>
            <!-- For Production Columns -->
            <!-- For Production Columns -->
            <th>
              <input type="checkbox" [(ngModel)]="selectAllChecked" (change)="toggleAllCheckboxes()"
                [disabled]="isViewer()" />
            </th>
            <th style="width: 40px;">NO</th>
            <th style="min-width: 80px;">M/R No.</th>
            <th (click)="onSort('DocNo')" style="min-width: 110px;">Document <span *ngIf="sortKey === 'DocNo'">{{
                sortAsc ? '↑' : '↓' }}</span></th>
            <th (click)="onSort('DateTime_Record')" style="min-width: 85px;">Date <span
                *ngIf="sortKey === 'DateTime_Record'">{{ sortAsc ? '↑' : '↓' }}</span></th>
            <th (click)="onSort('Requester')" style="min-width: 60px;">Req By <span *ngIf="sortKey === 'Requester'">{{
                sortAsc ? '↑' : '↓' }}</span></th>
            <th (click)="onSort('Division')" style="width: 50px;">Div <span *ngIf="sortKey === 'Division'">{{ sortAsc
                ?
                '↑' : '↓' }}</span></th>
            <th (click)="onSort('Process')" style="width: 70px;">Process <span *ngIf="sortKey === 'Process'">{{
                sortAsc
                ? '↑' : '↓' }}</span></th>
            <th (click)="onSort('Fac')" style="width: 40px;">Fac <span *ngIf="sortKey === 'Fac'">{{ sortAsc ? '↑' :
                '↓'
                }}</span></th>
            <th (click)="onSort('MCType')" style="width: 60px;">MC Type <span *ngIf="sortKey === 'MCType'">{{ sortAsc
                ?
                '↑' : '↓' }}</span></th>
            <th (click)="onSort('MCQTY')" style="width: 60px;">MC No <span *ngIf="sortKey === 'MCQTY'">{{ sortAsc ?
                '↑'
                : '↓' }}</span></th>
            <th (click)="onSort('CASE')" style="width: 50px;">Case <span *ngIf="sortKey === 'CASE'">{{ sortAsc ? '↑' :
                '↓' }}</span></th>
            <th (click)="onSort('ItemNo')" style="min-width: 110px;">Item NO. <span *ngIf="sortKey === 'ItemNo'">{{
                sortAsc ? '↑' : '↓' }}</span></th>
            <th (click)="onSort('PartNo')" style="min-width: 110px;">Item Name <span *ngIf="sortKey === 'PartNo'">{{
                sortAsc ? '↑' : '↓' }}</span></th>
            <th (click)="onSort('SPEC')" style="min-width: 180px;">Spec <span *ngIf="sortKey === 'SPEC'">{{ sortAsc ?
                '↑' : '↓' }}</span></th>
            <th (click)="onSort('Req_QTY')" style="width: 40px;">QTY <span *ngIf="sortKey === 'Req_QTY'">{{ sortAsc ?
                '↑' : '↓' }}</span></th>
            <th style="width: 40px;">Total</th>
            <th (click)="onSort('ON_HAND')" style="width: 50px;">On Hand <span *ngIf="sortKey === 'ON_HAND'">{{
                sortAsc
                ? '↑' : '↓' }}</span></th>
            <th (click)="onSort('Status')" style="min-width: 70px;">Status <span *ngIf="sortKey === 'Status'">{{
                sortAsc
                ? '↑' : '↓' }}</span></th>
            <th style="width: 50px;">Dwg</th>
            <th style="width: 50px;">Layout</th>
            <th style="min-width: 80px;">Phone</th>

            <!-- For Purchase Columns -->
            <th style="min-width: 110px;">Item NO.</th>
            <th style="min-width: 110px;">Item Name</th>
            <th style="min-width: 140px;">Spec</th>
            <th (click)="onSort('QTY')" style="width: 50px;">QTY <span *ngIf="sortKey === 'QTY'">{{ sortAsc ? '↑' :
                '↓'
                }}</span></th>
            <th style="min-width: 90px;">PH Stock Loc</th>
            <th style="width: 70px;">Stock PD</th>
            <th style="width: 70px;">PH Stock</th>
            <th style="width: 60px;">Confirm</th>
            <th style="min-width: 100px;">Remark</th>
          </tr>
        </thead>


        <!-- ในตาราง -->
        <tbody>
          <tr *ngFor="let item of displayedRequests; let i = index; trackBy: trackByRequestId" [ngClass]="{
            'editing-row': editingIndex[item.ID_Request] === i,
            'highlight-row': highlightedRow === i}">

            <!-- Checkbox -->
            <td><input type="checkbox" [(ngModel)]="item.Selection" [disabled]="isViewer()" /></td>

            <!-- NO -->
            <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>

            <!-- M/R No. -->
            <td>{{ item.DateTime_Record | date:'yyyyMMdd' }}</td>

            <!-- Document -->
            <td style="white-space: nowrap;">{{ item.DocNo }}</td>

            <!-- Date -->
            <td>{{ item.DateTime_Record | date:'dd/MM/yyyy'}}</td>

            <!-- Request By -->
            <td>{{ item.Requester }}</td>

            <!-- Division -->
            <td>{{ item.Division}}</td>

            <!-- Process -->
            <td>{{ item.Process }}</td>

            <!-- Fac -->
            <td>{{ item.Fac }}</td>

            <!-- MC Type -->
            <td>{{ item.MCType }}</td>

            <!-- MC No -->
            <td>{{ item.MCQTY }}</td>

            <!-- Case -->
            <td>{{ item.CASE }}</td>

            <!-- Item NO. -->
            <td>{{ item.ItemNo }}</td>

            <!-- Item Name (PartNo) -->
            <td>{{ item.PartNo }}</td>

            <!-- Spec -->
            <td class="spec-column">{{ item.SPEC }}</td>

            <!-- QTY (Req_QTY) -->
            <td>{{ item.Req_QTY }}</td>

            <!-- Total (New) - Placeholder or calculation -->
            <td> - </td>

            <!-- On Hand -->
            <td>{{ item.ON_HAND }}</td>

            <!-- Status -->
            <td>{{ item.Status }}</td>

            <!-- Dwg -->
            <td>
              <button *ngIf="item.PathDwg" class="btn btn-link btn-sm text-primary p-0"
                (click)="openPdfFromPath(item.PathDwg)">
                <i class="bi bi-file-earmark-pdf-fill text-danger"></i>
              </button>
            </td>

            <!-- Layout -->
            <td>
              <button *ngIf="item.PathLayout" class="btn btn-link btn-sm text-primary p-0"
                (click)="openPdfFromPath(item.PathLayout)">
                <i class="bi bi-file-earmark-pdf-fill text-danger"></i>
              </button>
            </td>

            <!-- Phone -->
            <td>{{ item.PhoneNo }}</td>

            <!-- ================= For Purchase ================= -->

            <!-- Item NO. -->
            <td>{{ item.ItemNo }}</td>

            <!-- Item Name -->
            <td>{{ item.PartNo }}</td>

            <!-- Spec -->
            <td>{{ item.SPEC }}</td>

            <!-- QTY (Editable) -->
            <td>
              <ng-container *ngIf="editingIndex[item.ID_Request] === i; else showQty">
                <input [(ngModel)]="item.QTY" type="number" class="form-control" style="width: 80px;" min="0" />
              </ng-container>
              <ng-template #showQty>
                <span (click)="startEdit(item.ID_Request, i)" style="cursor: pointer; text-decoration: underline;">{{
                  item.QTY }}</span>
              </ng-template>
            </td>

            <!-- PH Stock Location (Placeholder) -->
            <td></td>

            <!-- Stock PD Qty (Placeholder) -->
            <td></td>

            <!-- PH Stock Qty (Placeholder) -->
            <td></td>

            <!-- PH Confirm (Button to Save or Status Change) -->
            <td>
              <button class="btn btn-success btn-sm btn-ok" (click)="saveEdit(item.ID_Request, i)">OK</button>
            </td>

            <!-- Remark -->
            <td>
              <input *ngIf="editingIndex[item.ID_Request] === i" type="text" class="form-control"
                [(ngModel)]="item.Remark" />
              <span *ngIf="editingIndex[item.ID_Request] !== i">{{ item.Remark }}</span>
            </td>

          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls (Fixed Bottom) -->
    <div class="pagination-wrapper" *ngIf="totalPages > 1">
      <div class="d-inline-block bg-white p-2 rounded shadow-sm border">
        <span class="me-3">
          Showing {{ (currentPage - 1) * pageSize + 1 }} - {{ min((currentPage * pageSize), request.length) }} of {{
          request.length }}
        </span>
        <div class="d-inline-block">
          <nav aria-label="Page navigation">
            <ul class="pagination mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <button class="page-link" (click)="onPageChange(currentPage - 1)">Previous</button>
              </li>

              <li class="page-item" [class.active]="page === currentPage" *ngFor="let page of pages">
                <button class="page-link" (click)="onPageChange(page)">{{ page }}</button>
              </li>

              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <button class="page-link" (click)="onPageChange(currentPage + 1)">Next</button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>