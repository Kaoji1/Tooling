  <div class="detail-layout">

    <app-sidebarpurchase></app-sidebarpurchase>

    <div class="main">
      <!-- ข้อความข้างบน   -->
      <div class="toptext">
        <h1>Detail</h1>
        <p>detail item request</p>
      </div>

      <div class="top-right-icons">
        <button onclick="history.back()" class="back-btn">
          <img src="back arrow.png" alt="Back">
        </button>

        <div class="bell-container">
          <!-- <app-notification class="noti"></app-notification> -->
        </div>
      </div>

      <div class="group-header">

        <div class="Box-itemNo">
          <h4>ItemNo: {{ itemNo }}</h4>
        </div>
        <div class="button-Complete">
          <button class="btn-Complete" type="button" (click)="completeSelected()">
            Complete
          </button>

        </div>
      </div>

      <!-- กล่อง item no -->
      <!-- ตาราง -->

      <div class="table-responsive">
        <table class="table table-bordered text-center">

          <thead>
            <tr>
              <th>
                <input type="checkbox" [(ngModel)]="selectAllChecked" (change)="toggleAllCheckboxes()" />
              </th>
              <th>Document</th>
              <th>Requester</th>
              <th style="white-space: nowrap;">Part No.</th>
              <th style="width: 600px;">Item No.</th>
              <th>Spec</th>
              <th>Process</th>
              <!-- <th>ItemNo</th> chaeck itemno -->
              <th style="white-space: nowrap;">MC Type</th>
              <th>Fac</th>
              <th>DWG</th>
              <th style="white-space: nowrap;">On Hand</th>
              <th style="white-space: nowrap;">Req QTY</th>
              <th style="width: 120px;">QTY</th>
              <th style="white-space: nowrap;">Due Date</th>
              <th>Case</th>
              <th>Status</th>
              <th>Dwg</th>
              <th>Layout</th>
              <th style="white-space: nowrap;">Phone Number</th>
              <th>Remark</th>
              <th style="white-space: nowrap;">Edit</th>
              <th>Del</th>


            </tr>
          </thead>

          <!-- ในตาราง -->
          <tbody>
            <tr *ngIf="request.length === 0">
              <td colspan="11" class="text-center text-muted"> <i class="bi bi-exclamation-circle-fill"></i> Please
                select the to view item.</td>
            </tr>
            <tr *ngFor="let item of request; let i = index" [ngClass]="{
              'editing-row': editingIndex[item.ID_Request] === i,
              'highlight-row': highlightedRow === i}">

              <td><input type="checkbox" [(ngModel)]="item.Selection" /></td>
              <!--เชื่อม checkbox-->

              <td>{{ item.DocNo }}</td>
              <td>{{ item.Requester }}</td>
              <td class="PartNo-column">{{ item.PartNo }}</td>
              <td>
                <span *ngIf="editingIndex[item.ID_Request] !== i">{{ item.ItemNo }}</span>

                <ng-select *ngIf="editingIndex[item.ID_Request] === i" [items]="ItemNo" bindLabel="ItemNo"
                  bindValue="ItemNo" [(ngModel)]="item.ItemNo" [searchable]="true" [virtualScroll]="true"
                  (ngModelChange)="onItemNoChange($event, item)" [clearable]="true" placeholder="Select Item No"
                  style="width:150px;">
                </ng-select>
              </td>

              <td class="spec-column">{{ item.SPEC }}</td>
              <td>{{ item.Process }}</td>
              <td>{{ item.MCType }}</td>
              <td>{{ item.Fac }}</td>
              <td>{{ item.DwgRev }}</td>
              <td>{{ item.ON_HAND }}</td>
              <td>{{ item.Req_QTY }}</td>


              <td>
                <ng-container *ngIf="editingIndex[item.ID_Request] === i; else showQty">
                  <input [(ngModel)]="item.QTY" type="number" class="form-control" style="width:100px;" />
                </ng-container>
                <ng-template #showQty>{{ item.QTY }}</ng-template>
              </td>
              <td>{{ item.DueDate | date:'dd/MM/yyyy' }}</td>
              <td>{{ item.CASE }}</td>
              <td>{{ item.Status }}</td>

              <td>
                <!-- {{ item.PathDwg }} -->
                <div class="text-break"></div>
                <button *ngIf="item.PathDwg" class="btn btn-link btn-sm text-primary p-0 mt-1"
                  (click)="openPdfFromPath(item.PathDwg)">
                  <i class="bi bi-file-earmark-pdf-fill text-danger"></i> View
                </button>
              </td>

              <td>
                <!-- {{ item.PathLayout }} -->
                <div class="text-break"></div>
                <button *ngIf="item.PathLayout" class="btn btn-link btn-sm text-primary p-0 mt-1"
                  (click)="openPdfFromPath(item.PathLayout)">
                  <i class="bi bi-file-earmark-pdf-fill text-danger"></i> View
                </button>
              </td>

              <td>{{ item.PhoneNo }}</td>

              <td>
                <span *ngIf="editingIndex[item.ID_Request] !== i">{{ item.Remark }}</span>
                <input *ngIf="editingIndex[item.ID_Request] === i" type="text" [(ngModel)]="item.Remark" type="text" />
              </td>
              <td>

                <button *ngIf="editingIndex[item.ID_Request] !== i" class="btn btn-primary btn-sm"
                  (click)="startEdit(item.ID_Request, i)">
                  <i class="bi bi-pencil-square text-white"></i>
                </button>

                <button *ngIf="editingIndex[item.ID_Request] === i" class="btn btn-success btn-sm"
                  (click)="saveEdit(item.ID_Request, i)">
                  <i class="bi bi-check-lg text-white"></i>
                </button>

                <button *ngIf="!item.isNew && editingIndex[item.ID_Request] === i" class="btn btn-lg" (click)="addNewRequest({ 
              DocNo: item.DocNo,
              Division: item.Division,
              Requester: item.Requester,
              PartNo: item.PartNo,
              ItemNo: item.ItemNo,
              Req_QTY: item.Req_QTY,
              Remark: item.Remark,
              Status: item.Status,
              SPEC: item.SPEC,
              Process: item.Process,
              MCType: item.MCType,
              ON_HAND: item.ON_HAND,
              Fac: item.Fac,
              DwgRev: item.DwgRev,
              DueDate: item.DueDate,
              CASE: item.CASE,
              PathDwg: item.PathDwg,
              PathLayout: item.PathLayout
          }, i)">
                  <i class="bi bi-plus-circle text-black"></i>
                </button>
              </td>

              <td>
                <button class="btn btn-danger btn-sm" (click)="deleteItem(item.ID_Request)">
                  <i class="bi bi-trash text-white"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
